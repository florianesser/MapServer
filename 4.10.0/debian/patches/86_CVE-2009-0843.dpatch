#! /bin/sh /usr/share/dpatch/dpatch-run
## 86_CVE-2009-0843.dpatch by Alan Boudreault <aboudreault@mapgears.com>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: No description.

@DPATCH@
diff -urNad mapserver-4.10.0~/mapquery.c mapserver-4.10.0/mapquery.c
--- mapserver-4.10.0~/mapquery.c	2006-02-01 20:00:11.000000000 -0500
+++ mapserver-4.10.0/mapquery.c	2009-07-14 13:12:34.260614243 -0400
@@ -153,6 +153,11 @@
     return(MS_FAILURE);
   }
 
+  /*
+  ** Make sure the file at least has the right extension.
+  */
+  if(msEvalRegex("\\.qy$", filename) != MS_TRUE) return MS_FAILURE;
+
   stream = fopen(filename, "rb");
   if(!stream) {
     msSetError(MS_IOERR, "(%s)", "msLoadQuery()", filename);
