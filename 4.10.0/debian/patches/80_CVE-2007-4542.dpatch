#! /bin/sh /usr/share/dpatch/dpatch-run
## 80_CVE-2007-4542.dpatch by Devin Carraway <devin@debian.org>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: Upstream patch for CVE-2007-4542, fixing overflows in template
## DP: handlers and an XSS vulnerability.


@DPATCH@
Index: maptemplate.c
===================================================================
--- a/maptemplate.c	(revision 6672)
+++ b/maptemplate.c	(working copy)
@@ -2790,10 +2790,15 @@
   } /* end query mode specific substitutions */
 
   for(i=0;i<msObj->request->NumParams;i++) {
-    sprintf(substr, "[%s]", msObj->request->ParamNames[i]);
-    outstr = gsub(outstr, substr, msObj->request->ParamValues[i]);
-    sprintf(substr, "[%s_esc]", msObj->request->ParamNames[i]);
+    /* Replace [variable] tags using values from URL. We cannot offer a
+     * [variable_raw] option here due to the risk of XSS
+     */
+    snprintf(substr, PROCESSLINE_BUFLEN, "[%s]", msObj->request->ParamNames[i]);
+    encodedstr = msEncodeHTMLEntities(msObj->request->ParamValues[i]);
+    outstr = gsub(outstr, substr, encodedstr);
+    free(encodedstr);
 
+    snprintf(substr, PROCESSLINE_BUFLEN, "[%s_esc]", msObj->request->ParamNames[i]);
     encodedstr = msEncodeUrl(msObj->request->ParamValues[i]);
     outstr = gsub(outstr, substr, encodedstr);
     free(encodedstr);
Index: mapserv.c
===================================================================
--- a/mapserv.c	(revision 6672)
+++ b/mapserv.c	(working copy)
@@ -177,7 +177,7 @@
     msIO_printf("<HEAD><TITLE>MapServer Message</TITLE></HEAD>\n");
     msIO_printf("<!-- %s -->\n", msGetVersion());
     msIO_printf("<BODY BGCOLOR=\"#FFFFFF\">\n");
-    msWriteError(stdout);
+    msWriteErrorXML(stdout);
     msIO_printf("</BODY></HTML>");
     msCleanup();
     exit(0);
@@ -191,7 +191,7 @@
       msIO_printf("<HEAD><TITLE>MapServer Message</TITLE></HEAD>\n");
       msIO_printf("<!-- %s -->\n", msGetVersion());
       msIO_printf("<BODY BGCOLOR=\"#FFFFFF\">\n");
-      msWriteError(stdout);
+      msWriteErrorXML(stdout);
       msIO_printf("</BODY></HTML>");
     }
   } else {
@@ -203,7 +203,7 @@
 	msIO_printf("<HEAD><TITLE>MapServer Message</TITLE></HEAD>\n");
 	msIO_printf("<!-- %s -->\n", msGetVersion());
 	msIO_printf("<BODY BGCOLOR=\"#FFFFFF\">\n");
-	msWriteError(stdout);
+	msWriteErrorXML(stdout);
 	msIO_printf("</BODY></HTML>");
       }
     } else {
@@ -212,7 +212,7 @@
       msIO_printf("<HEAD><TITLE>MapServer Message</TITLE></HEAD>\n");
       msIO_printf("<!-- %s -->\n", msGetVersion());
       msIO_printf("<BODY BGCOLOR=\"#FFFFFF\">\n");
-      msWriteError(stdout);
+      msWriteErrorXML(stdout);
       msIO_printf("</BODY></HTML>");
     }
   }
