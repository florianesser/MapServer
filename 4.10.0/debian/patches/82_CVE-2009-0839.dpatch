#! /bin/sh /usr/share/dpatch/dpatch-run
## 82_CVE-2009-0839.dpatch by Alan Boudreault <aboudreault@mapgears.com>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: No description.

@DPATCH@
diff -urNad mapserver-4.10.0~/map.h mapserver-4.10.0/map.h
--- mapserver-4.10.0~/map.h	2006-10-04 10:54:49.000000000 -0400
+++ mapserver-4.10.0/map.h	2009-07-14 13:06:22.521857713 -0400
@@ -242,7 +242,9 @@
 /* General defines, not wrapable */
 #ifndef SWIG
 #define MS_DEFAULT_MAPFILE_PATTERN "\\.map$"
-#define MS_TEMPLATE_EXPR "\\.(jsp|asp|cfm|xml|wml|html|htm|shtml|phtml|php|svg)$"
+
+#define MS_TEMPLATE_MAGIC_STRING "MapServer Template"
+#define MS_TEMPLATE_EXPR "\\.(xml|wml|html|htm|svg|kml|gml|js|tmpl)$"
 
 #define MS_INDEX_EXTENSION ".qix"
 #define MS_QUERY_EXTENSION ".qy"
@@ -1482,6 +1484,7 @@
 MS_DLL_EXPORT char *msJoinStrings(char **array, int arrayLength, const char *delimeter);
 MS_DLL_EXPORT char *msHashString(const char *pszStr);
 MS_DLL_EXPORT char *msCommifyString(char *str);
+MS_DLL_EXPORT const char *msCaseFindSubstring(const char *haystack, const char *needle);
 
 #ifdef NEED_STRDUP
 MS_DLL_EXPORT char *strdup(char *s);
diff -urNad mapserver-4.10.0~/mapserv.c mapserver-4.10.0/mapserv.c
--- mapserver-4.10.0~/mapserv.c	2006-08-28 21:56:53.000000000 -0400
+++ mapserver-4.10.0/mapserv.c	2009-07-14 13:06:22.521857713 -0400
@@ -278,8 +278,21 @@
   } else {
     if(getenv(msObj->request->ParamValues[i])) /* an environment references the actual file to use */
       map = msLoadMap(getenv(msObj->request->ParamValues[i]), NULL);
-    else
+    else {
+      /* by here we know the request isn't for something in an environment variable */
+      if(getenv("MS_MAP_NO_PATH")) {
+        msSetError(MS_WEBERR, "Mapfile not found in environment variables and this server is not configured for full paths.", "loadMap()");
+	writeError();
+      }
+
+      if(getenv("MS_MAP_PATTERN") && msEvalRegex(getenv("MS_MAP_PATTERN"), msObj->request->ParamValues[i]) != MS_TRUE) {
+        msSetError(MS_WEBERR, "Parameter 'map' value fails to validate.", "loadMap()");
+        writeError();
+      }
+
+      /* ok to try to load now */
       map = msLoadMap(msObj->request->ParamValues[i], NULL);
+    }
   }
 
   if(!map) writeError();
@@ -415,6 +428,10 @@
     }
 
     if(strcasecmp(msObj->request->ParamNames[i],"id") == 0) {
+      if(msEvalRegex(IDPATTERN, msObj->request->ParamValues[i]) == MS_FALSE) {
+        msSetError(MS_WEBERR, "Parameter 'id' value fails to validate.", "loadMap()");
+	writeError();
+      }
       strncpy(msObj->Id, msObj->request->ParamValues[i], IDSIZE);
       continue;
     }
@@ -1238,7 +1255,7 @@
     loadForm();
  
     if(msObj->SaveMap) {
-      sprintf(buffer, "%s%s%s.map", msObj->Map->web.imagepath, msObj->Map->name, msObj->Id);
+      snprintf(buffer, sizeof(buffer), "%s%s%s.map", msObj->Map->web.imagepath, msObj->Map->name, msObj->Id);
       if(msSaveMap(msObj->Map, buffer) == -1) writeError();
     }
 
diff -urNad mapserver-4.10.0~/mapstring.c mapserver-4.10.0/mapstring.c
--- mapserver-4.10.0~/mapstring.c	2006-08-16 10:05:07.000000000 -0400
+++ mapserver-4.10.0/mapstring.c	2009-07-14 13:06:22.521857713 -0400
@@ -933,3 +933,34 @@
 
   return str;
 }
+
+/************************************************************************/
+/*                  case incensitive equivalent of strstr               */
+/************************************************************************/
+const char *msCaseFindSubstring(const char *haystack, const char *needle)
+{
+  if ( !*needle )
+    {
+      return haystack;
+    }
+  for ( ; *haystack; ++haystack )
+    {
+      if ( toupper(*haystack) == toupper(*needle) )
+        {
+	  /*          * Matched starting char -- loop through remaining chars.          */
+	  const char *h, *n;
+	  for ( h = haystack, n = needle; *h && *n; ++h, ++n )
+            {
+	      if ( toupper(*h) != toupper(*n) )
+		{
+		  break;
+                }
+            }
+	  if ( !*n ) /* matched all of 'needle' to null termination */
+            {
+	      return haystack; /* return the start of the match */
+            }
+        }
+    }
+  return 0;
+}
diff -urNad mapserver-4.10.0~/maptemplate.c mapserver-4.10.0/maptemplate.c
--- mapserver-4.10.0~/maptemplate.c	2006-09-29 16:52:05.000000000 -0400
+++ mapserver-4.10.0/maptemplate.c	2009-07-14 13:06:22.521857713 -0400
@@ -130,6 +130,20 @@
 
 char *processLine(mapservObj* msObj, char* instr, int mode);
 
+static int isValidTemplate(FILE *stream, const char *filename)
+{
+  char buffer[MS_BUFFER_LENGTH];
+
+  if(fgets(buffer, MS_BUFFER_LENGTH, stream) != NULL) {
+    if(!msCaseFindSubstring(buffer, MS_TEMPLATE_MAGIC_STRING)) {
+      msSetError(MS_WEBERR, "Missing magic string, %s doesn't look like a MapServer template.", "isValidTemplate()", filename);
+      return MS_FALSE;
+    }
+  }
+
+  return MS_TRUE;
+}
+
 /*
  * Redirect to (only use in CGI)
  * 
@@ -293,7 +307,7 @@
       img = msDrawQueryMap(msObj->Map);
       if(!img) return MS_FAILURE;
 
-      snprintf(buffer, 1024, "%s%s%s.%s", msObj->Map->web.imagepath, msObj->Map->name, msObj->Id, MS_IMAGE_EXTENSION(msObj->Map->outputformat));
+      snprintf(buffer, sizeof(buffer), "%s%s%s.%s", msObj->Map->web.imagepath, msObj->Map->name, msObj->Id, MS_IMAGE_EXTENSION(msObj->Map->outputformat));
 
       status = msSaveImage(msObj->Map, img, buffer);
       if(status != MS_SUCCESS) return status;
@@ -304,7 +318,7 @@
       {
          img = msDrawLegend(msObj->Map, MS_FALSE);
          if(!img) return MS_FAILURE;
-         snprintf(buffer, 1024, "%s%sleg%s.%s", msObj->Map->web.imagepath, msObj->Map->name, msObj->Id, MS_IMAGE_EXTENSION(msObj->Map->outputformat));
+         snprintf(buffer, sizeof(buffer), "%s%sleg%s.%s", msObj->Map->web.imagepath, msObj->Map->name, msObj->Id, MS_IMAGE_EXTENSION(msObj->Map->outputformat));
          status = msSaveImage(msObj->Map, img, buffer);
          if(status != MS_SUCCESS) return status;
          msFreeImage(img);
@@ -314,7 +328,7 @@
       {
          img = msDrawScalebar(msObj->Map);
          if(!img) return MS_FAILURE;
-         snprintf(buffer, 1024, "%s%ssb%s.%s", msObj->Map->web.imagepath, msObj->Map->name, msObj->Id, MS_IMAGE_EXTENSION(msObj->Map->outputformat));
+         snprintf(buffer, sizeof(buffer), "%s%ssb%s.%s", msObj->Map->web.imagepath, msObj->Map->name, msObj->Id, MS_IMAGE_EXTENSION(msObj->Map->outputformat));
          status = msSaveImage( msObj->Map, img, buffer);
          if(status != MS_SUCCESS) return status;
          msFreeImage(img);
@@ -324,7 +338,7 @@
       {
          img = msDrawReferenceMap(msObj->Map);
          if(!img) return MS_FAILURE;
-         snprintf(buffer, 1024, "%s%sref%s.%s", msObj->Map->web.imagepath, msObj->Map->name, msObj->Id, MS_IMAGE_EXTENSION(msObj->Map->outputformat));
+         snprintf(buffer, sizeof(buffer), "%s%sref%s.%s", msObj->Map->web.imagepath, msObj->Map->name, msObj->Id, MS_IMAGE_EXTENSION(msObj->Map->outputformat));
          status = msSaveImage(msObj->Map, img, buffer);
          if(status != MS_SUCCESS) return status;
          msFreeImage(img);
@@ -2446,6 +2460,11 @@
           return(NULL);
         }
 
+        if(isValidTemplate(stream, join->header) != MS_TRUE) {
+          fclose(stream);
+          return NULL;
+	}
+
         /* echo file to the output buffer, no substitutions */
         while(fgets(line, MS_BUFFER_LENGTH, stream) != NULL) outbuf = strcatalloc(outbuf, line);
 
@@ -2455,8 +2474,13 @@
       if((stream = fopen(msBuildPath(szPath, msObj->Map->mappath, join->template), "r")) == NULL) {
         msSetError(MS_IOERR, "Error while opening join template file %s.", "processOneToManyJoin()", join->template);
         return(NULL);
-      }      
+      }
       
+      if(isValidTemplate(stream, join->header) != MS_TRUE) {
+	fclose(stream);
+	return NULL;
+      }
+
       records = MS_TRUE;
     }
     
@@ -2471,6 +2495,7 @@
     }
       
     rewind(stream);
+    fgets(line, MS_BUFFER_LENGTH, stream); /* skip the first line since it's the magic string */
   } /* next record */
 
   if(records==MS_TRUE && join->footer) {    
@@ -2479,6 +2504,11 @@
       return(NULL);
     }
 
+    if(isValidTemplate(stream, join->footer) != MS_TRUE) {
+      fclose(stream);
+      return NULL;
+    }
+
     /* echo file to the output buffer, no substitutions */
     while(fgets(line, MS_BUFFER_LENGTH, stream) != NULL) outbuf = strcatalloc(outbuf, line);
     
@@ -3007,6 +3037,11 @@
     return MS_FAILURE;
   } 
 
+  if(isValidTemplate(stream, html) != MS_TRUE) {
+    fclose(stream);
+    return MS_FAILURE;
+  }
+
   if (papszBuffer)
   {
       if ((*papszBuffer) == NULL)
@@ -3411,7 +3446,7 @@
         image = msDrawMap(msObj->Map);
 
       if(image) { 
-        sprintf(buffer, "%s%s%s.%s", msObj->Map->web.imagepath, msObj->Map->name, msObj->Id, MS_IMAGE_EXTENSION(msObj->Map->outputformat));
+        snprintf(buffer, sizeof(buffer), "%s%s%s.%s", msObj->Map->web.imagepath, msObj->Map->name, msObj->Id, MS_IMAGE_EXTENSION(msObj->Map->outputformat));
 
         if(msSaveImage(msObj->Map, image, buffer) != MS_SUCCESS && bReturnOnError) {
           msFreeImage(image);
@@ -3429,7 +3464,7 @@
       imageObj *image = NULL;
       image = msDrawLegend(msObj->Map, MS_FALSE);
       if(image) { 
-        sprintf(buffer, "%s%sleg%s.%s", msObj->Map->web.imagepath, msObj->Map->name, msObj->Id, MS_IMAGE_EXTENSION(msObj->Map->outputformat));
+        snprintf(buffer, sizeof(buffer), "%s%sleg%s.%s", msObj->Map->web.imagepath, msObj->Map->name, msObj->Id, MS_IMAGE_EXTENSION(msObj->Map->outputformat));
                 
         if(msSaveImage(msObj->Map, image, buffer) != MS_SUCCESS && bReturnOnError) {
           msFreeImage(image);
@@ -3447,7 +3482,7 @@
       imageObj *image = NULL;
       image = msDrawScalebar(msObj->Map);
       if(image) {
-        sprintf(buffer, "%s%ssb%s.%s", msObj->Map->web.imagepath, msObj->Map->name, msObj->Id, MS_IMAGE_EXTENSION(msObj->Map->outputformat));
+        snprintf(buffer, sizeof(buffer), "%s%ssb%s.%s", msObj->Map->web.imagepath, msObj->Map->name, msObj->Id, MS_IMAGE_EXTENSION(msObj->Map->outputformat));
         if(msSaveImage(msObj->Map, image, buffer) != MS_SUCCESS && bReturnOnError) {
           msFreeImage(image);
           return MS_FALSE;
@@ -3464,7 +3499,7 @@
       imageObj *image;
       image = msDrawReferenceMap(msObj->Map);
       if(image) { 
-        sprintf(buffer, "%s%sref%s.%s", msObj->Map->web.imagepath, msObj->Map->name, msObj->Id, MS_IMAGE_EXTENSION(msObj->Map->outputformat));
+        snprintf(buffer, sizeof(buffer), "%s%sref%s.%s", msObj->Map->web.imagepath, msObj->Map->name, msObj->Id, MS_IMAGE_EXTENSION(msObj->Map->outputformat));
         if(msSaveImage(msObj->Map, image, buffer) != MS_SUCCESS && bReturnOnError) {
           msFreeImage(image);
           return MS_FALSE;
diff -urNad mapserver-4.10.0~/maptemplate.h mapserver-4.10.0/maptemplate.h
--- mapserver-4.10.0~/maptemplate.h	2005-06-14 12:03:35.000000000 -0400
+++ mapserver-4.10.0/maptemplate.h	2009-07-14 13:06:22.521857713 -0400
@@ -45,7 +45,8 @@
 #include "map.h"
 #include "maphash.h"
 
-#define IDSIZE 128
+#define IDPATTERN "^[0-9A-Za-z]{1,63}$"
+#define IDSIZE 64
 #define TEMPLATE_TYPE(s)  (((strncmp("http://", s, 7) == 0) || (strncmp("https://", s, 8) == 0) || (strncmp("ftp://", s, 6)) == 0)  ? MS_URL : MS_FILE)
 #define MAXZOOM 25
 #define MINZOOM -25
