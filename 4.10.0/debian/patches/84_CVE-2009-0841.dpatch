#! /bin/sh /usr/share/dpatch/dpatch-run
## 84_CVE-2009-0841.dpatch by Alan Boudreault <aboudreault@mapgears.com>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: No description.

@DPATCH@
diff -urNad mapserver-4.10.0~/mapserv.c mapserver-4.10.0/mapserv.c
--- mapserver-4.10.0~/mapserv.c	2006-08-28 21:56:53.000000000 -0400
+++ mapserver-4.10.0/mapserv.c	2009-07-14 13:10:06.254163494 -0400
@@ -415,6 +428,10 @@
     }
 
     if(strcasecmp(msObj->request->ParamNames[i],"id") == 0) {
+      if(msEvalRegex(IDPATTERN, msObj->request->ParamValues[i]) == MS_FALSE) {
+        msSetError(MS_WEBERR, "Parameter 'id' value fails to validate.", "loadMap()");
+	writeError();
+      }
       strncpy(msObj->Id, msObj->request->ParamValues[i], IDSIZE);
       continue;
     }
diff -urNad mapserver-4.10.0~/maptemplate.h mapserver-4.10.0/maptemplate.h
--- mapserver-4.10.0~/maptemplate.h	2005-06-14 12:03:35.000000000 -0400
+++ mapserver-4.10.0/maptemplate.h	2009-07-14 13:06:22.521857713 -0400
@@ -46,7 +46,8 @@
 #include "maphash.h"
 
 #define IDSIZE 64
+#define IDPATTERN "^[0-9A-Za-z]{1,63}$"
 #define TEMPLATE_TYPE(s)  (((strncmp("http://", s, 7) == 0) || (strncmp("https://", s, 8) == 0) || (strncmp("ftp://", s, 6)) == 0)  ? MS_URL : MS_FILE)
 #define MAXZOOM 25
 #define MINZOOM -25
