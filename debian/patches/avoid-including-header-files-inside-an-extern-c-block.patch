From c67a74b5f11747aab1a251ef601ced72e55107f8 Mon Sep 17 00:00:00 2001
From: Thomas Bonfort <thomas.bonfort@gmail.com>
Date: Thu, 9 Jul 2015 15:13:42 +0200
Subject: [PATCH 1/2] Avoid including header files inside an extern C block
 (#5117)

---
 mapgml.c       |  1 +
 mapobject.c    |  1 +
 mapogcfilter.c |  1 +
 mapogcsld.c    |  1 +
 mapogcsos.c    |  1 +
 mapogr.cpp     |  1 +
 mapogroutput.c |  1 +
 mapows.c       |  1 +
 mapows.h       | 13 ++++++++++++-
 mapserver.h    |  6 ------
 mapwcs.c       |  1 +
 mapwcs11.c     |  1 +
 mapwcs20.c     |  1 +
 mapwfs.c       |  1 +
 mapwms.c       |  1 +
 mapwmslayer.c  |  1 +
 16 files changed, 26 insertions(+), 7 deletions(-)

diff --git a/mapgml.c b/mapgml.c
index 3e07119..52a6587 100644
--- a/mapgml.c
+++ b/mapgml.c
@@ -29,6 +29,7 @@
 
 #include "mapserver.h"
 #include "maperror.h"
+#include "mapows.h"
 #include "mapgml.h"
 #include "maptime.h"
 
diff --git a/mapobject.c b/mapobject.c
index 255b47c..8c5cdb5 100644
--- a/mapobject.c
+++ b/mapobject.c
@@ -29,6 +29,7 @@
  ****************************************************************************/
 
 #include "mapserver.h"
+#include "mapows.h"
 
 #ifdef USE_GDAL
 #  include "gdal.h"
diff --git a/mapogcfilter.c b/mapogcfilter.c
index 3d4bab8..50e7381 100644
--- a/mapogcfilter.c
+++ b/mapogcfilter.c
@@ -39,6 +39,7 @@
 #include "mapserver.h"
 #include "mapowscommon.h"
 #include "maptime.h"
+#include "mapows.h"
 
 static int FLTHasUniqueTopLevelDuringFilter(FilterEncodingNode *psFilterNode);
 
diff --git a/mapogcsld.c b/mapogcsld.c
index af0cb76..b3372ff 100644
--- a/mapogcsld.c
+++ b/mapogcsld.c
@@ -29,6 +29,7 @@
 #include "mapogcsld.h"
 #include "mapogcfilter.h"
 #include "mapserver.h"
+#include "mapows.h"
 
 #ifdef USE_OGR
 #include "cpl_string.h"
diff --git a/mapogcsos.c b/mapogcsos.c
index df09261..f709c48 100644
--- a/mapogcsos.c
+++ b/mapogcsos.c
@@ -30,6 +30,7 @@
 #define _GNU_SOURCE
 
 #include "mapserver.h"
+#include "mapows.h"
 
 #if defined(USE_SOS_SVR) && defined(USE_LIBXML2)
 
diff --git a/mapogr.cpp b/mapogr.cpp
index 1f21b29..1708d1c 100644
--- a/mapogr.cpp
+++ b/mapogr.cpp
@@ -32,6 +32,7 @@
 #include "mapserver.h"
 #include "mapproject.h"
 #include "mapthread.h"
+#include "mapows.h"
 
 #if defined(USE_OGR) || defined(USE_GDAL)
 #  include "gdal_version.h"
diff --git a/mapogroutput.c b/mapogroutput.c
index 3fac96f..ed12736 100644
--- a/mapogroutput.c
+++ b/mapogroutput.c
@@ -31,6 +31,7 @@
 #include "mapserver.h"
 #include "mapproject.h"
 #include "mapthread.h"
+#include "mapows.h"
 
 #if defined(USE_OGR)
 #  define __USE_LARGEFILE64 1
diff --git a/mapows.c b/mapows.c
index 617abc3..dd2d856 100644
--- a/mapows.c
+++ b/mapows.c
@@ -30,6 +30,7 @@
 #include "mapserver.h"
 #include "maptime.h"
 #include "maptemplate.h"
+#include "mapows.h"
 
 #if defined(USE_LIBXML2)
 #include "maplibxml2.h"
diff --git a/mapows.h b/mapows.h
index 4d7f41f..b8be8cc 100644
--- a/mapows.h
+++ b/mapows.h
@@ -40,6 +40,15 @@
  */
 #define OWS_DEFAULT_SCHEMAS_LOCATION   "http://schemas.opengis.net"
 
+#if defined USE_LIBXML2 && defined USE_WFS_SVR
+#include<libxml/tree.h>
+#endif
+
+#ifdef __cplusplus
+extern "C" {
+#endif
+
+
 /*====================================================================
  *   mapows.c
  *====================================================================*/
@@ -474,7 +483,6 @@ int msWFSException11(mapObj *map, const char *locator,
 int msWFSGetCapabilities11(mapObj *map, wfsParamsObj *wfsparams,
                            cgiRequestObj *req, owsRequestObj *ows_request);
 #ifdef USE_LIBXML2
-#include<libxml/tree.h>
 xmlNodePtr msWFSDumpLayer11(mapObj *map, layerObj *lp, xmlNsPtr psNsOws,
                           int nWFSVersion, const char* validate_language);
 #endif
@@ -535,6 +543,9 @@ int msWCSDispatch(mapObj *map, cgiRequestObj *requestobj, owsRequestObj *ows_req
 
 int msSOSDispatch(mapObj *map, cgiRequestObj *requestobj, owsRequestObj *ows_request); /* only 1 public function */
 
+#ifdef __cplusplus
+} /* extern "C" */
+#endif
 
 #endif /* MAPOWS_H */
 
diff --git a/mapserver.h b/mapserver.h
index ec91380..e02dcb3 100644
--- a/mapserver.h
+++ b/mapserver.h
@@ -2806,12 +2806,6 @@ void msPopulateTextSymbolForLabelAndString(textSymbolObj *ts, labelObj *l, char
                                   const char *pszEntryPoint);
 
   /* ==================================================================== */
-  /*      include definitions from mapows.h                               */
-  /* ==================================================================== */
-#include "mapows.h"
-
-
-  /* ==================================================================== */
   /*      prototypes for functions in mapgeos.c                         */
   /* ==================================================================== */
   MS_DLL_EXPORT void msGEOSSetup(void);
diff --git a/mapwcs.c b/mapwcs.c
index 3d5180e..380b6b2 100644
--- a/mapwcs.c
+++ b/mapwcs.c
@@ -30,6 +30,7 @@
 #include "mapserver.h"
 #include "maperror.h"
 #include "mapthread.h"
+#include "mapows.h"
 #include <assert.h>
 
 
diff --git a/mapwcs11.c b/mapwcs11.c
index 0385f52..8dbe948 100644
--- a/mapwcs11.c
+++ b/mapwcs11.c
@@ -33,6 +33,7 @@
 #include "mapserver.h"
 #include "maperror.h"
 #include "mapthread.h"
+#include "mapows.h"
 #include "mapwcs.h"
 
 
diff --git a/mapwcs20.c b/mapwcs20.c
index 95351b8..ac2fb89 100644
--- a/mapwcs20.c
+++ b/mapwcs20.c
@@ -36,6 +36,7 @@
 #include "mapserver.h"
 #include "maperror.h"
 #include "mapthread.h"
+#include "mapows.h"
 #include "mapwcs.h"
 #include <float.h>
 #include "gdal.h"
diff --git a/mapwfs.c b/mapwfs.c
index 0b28233..ed223d9 100644
--- a/mapwfs.c
+++ b/mapwfs.c
@@ -28,6 +28,7 @@
  ****************************************************************************/
 
 #include "mapserver.h"
+#include "mapows.h"
 
 
 
diff --git a/mapwms.c b/mapwms.c
index 17a3a09..d681d12 100644
--- a/mapwms.c
+++ b/mapwms.c
@@ -35,6 +35,7 @@
 #include "mapgml.h"
 #include <ctype.h>
 #include "maptemplate.h"
+#include "mapows.h"
 
 #include "mapogcsld.h"
 #include "mapogcfilter.h"
diff --git a/mapwmslayer.c b/mapwmslayer.c
index 9ba8f24..42a44f1 100644
--- a/mapwmslayer.c
+++ b/mapwmslayer.c
@@ -30,6 +30,7 @@
 #include "mapserver.h"
 #include "maperror.h"
 #include "mapogcsld.h"
+#include "mapows.h"
 
 #include <time.h>
 #include <ctype.h>

From 6aa5873862fb86b2b418de990e0b1319ff05b9e7 Mon Sep 17 00:00:00 2001
From: Thomas Bonfort <thomas.bonfort@gmail.com>
Date: Thu, 9 Jul 2015 15:24:32 +0200
Subject: [PATCH 2/2] missing mapows.h includes

---
 mapcontext.c       | 2 +-
 mapdraw.c          | 1 +
 mapkmlrenderer.cpp | 1 +
 3 files changed, 3 insertions(+), 1 deletion(-)

diff --git a/mapcontext.c b/mapcontext.c
index 1b71216..db9150c 100644
--- a/mapcontext.c
+++ b/mapcontext.c
@@ -27,7 +27,7 @@
  ****************************************************************************/
 
 #include "mapserver.h"
-
+#include "mapows.h"
 
 
 #if defined(USE_WMS_LYR) && defined(USE_OGR)
diff --git a/mapdraw.c b/mapdraw.c
index 1221b90..1a7a73a 100644
--- a/mapdraw.c
+++ b/mapdraw.c
@@ -33,6 +33,7 @@
 #include "maptime.h"
 #include "mapcopy.h"
 #include "mapfile.h"
+#include "mapows.h"
 
 
 /* msPrepareImage()
diff --git a/mapkmlrenderer.cpp b/mapkmlrenderer.cpp
index f65fb45..7829eb2 100644
--- a/mapkmlrenderer.cpp
+++ b/mapkmlrenderer.cpp
@@ -34,6 +34,7 @@
 #include "maperror.h"
 #include "mapkmlrenderer.h"
 #include "mapio.h"
+#include "mapows.h"
 
 #if defined(USE_OGR)
 #  include "cpl_conv.h"
