#! /bin/sh /usr/share/dpatch/dpatch-run
## 85_CVE-2009-0842.dpatch by Alan Boudreault <aboudreault@mapgears.com>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: No description.

@DPATCH@
diff -urNad mapserver-4.10.0~/mapfile.c mapserver-4.10.0/mapfile.c
--- mapserver-4.10.0~/mapfile.c	2006-08-31 22:30:15.000000000 -0400
+++ mapserver-4.10.0/mapfile.c	2009-07-14 13:11:33.301856800 -0400
@@ -4543,6 +4543,9 @@
   int i,j,k;
   char szPath[MS_MAXPATHLEN], szCWDPath[MS_MAXPATHLEN];
 
+  int foundMapToken=MS_FALSE;
+  int token;
+
   if(!filename) {
     msSetError(MS_MISCERR, "Filename is undefined.", "msLoadMap()");
     return(NULL);
@@ -4592,7 +4595,14 @@
 
   for(;;) {
 
-    switch(msyylex()) {   
+    token = msyylex();
+  
+    if(!foundMapToken && token != MAP) {
+      msSetError(MS_IDENTERR, "First token must be MAP, this doesn't look like a mapfile.", "msLoadMap()");
+      return(NULL);
+    }
+
+    switch(token) {
 
     case(CONFIG):
     {
@@ -4717,7 +4727,8 @@
       if(loadLegend(&(map->legend), map) == -1) return(NULL);
       break;
     case(MAP):
-      break;   
+      foundMapToken = MS_TRUE;
+      break;
     case(MAXSIZE):
       if(getInteger(&(map->maxsize)) == -1) return(NULL);
       break;
diff -urNad mapserver-4.10.0~/mapsymbol.c mapserver-4.10.0/mapsymbol.c
--- mapserver-4.10.0~/mapsymbol.c	2006-07-22 23:28:45.000000000 -0400
+++ mapserver-4.10.0/mapsymbol.c	2009-07-14 13:11:33.301856800 -0400
@@ -632,7 +632,7 @@
 int msLoadSymbolSet(symbolSetObj *symbolset, mapObj *map)
 {
     int retval = MS_FAILURE;
-    
+
     msAcquireLock( TLOCK_PARSER );
     retval = loadSymbolSet( symbolset, map );
     msReleaseLock( TLOCK_PARSER );
@@ -647,6 +647,9 @@
   int status=1;
   char szPath[MS_MAXPATHLEN], *pszSymbolPath=NULL;
 
+  int foundSymbolSetToken=MS_FALSE;
+  int token;
+
   if(!symbolset) {
     msSetError(MS_SYMERR, "Symbol structure unallocated.", "loadSymbolSet()");
     return(-1);
@@ -673,7 +676,15 @@
   ** Read the symbol file
   */
   for(;;) {
-    switch(msyylex()) {
+
+    token = msyylex();
+
+    if(!foundSymbolSetToken && token != SYMBOLSET) {
+      msSetError(MS_IDENTERR, "First token must be SYMBOLSET, this doesn't look like a symbol file.", "msLoadSymbolSet()");
+      return(-1);
+    }
+
+    switch(token) {
     case(END):
     case(EOF):      
       status = 0;
@@ -688,6 +699,7 @@
       symbolset->numsymbols++;
       break;
     case(SYMBOLSET):
+      foundSymbolSetToken = MS_TRUE;
       break;
     default:
       msSetError(MS_IDENTERR, "Parsing error near (%s):(line %d)", "loadSymbolSet()", msyytext, msyylineno);
diff -urNad mapserver-4.10.0~/tests/symbols.txt mapserver-4.10.0/tests/symbols.txt
--- mapserver-4.10.0~/tests/symbols.txt	2004-11-18 10:07:36.000000000 -0500
+++ mapserver-4.10.0/tests/symbols.txt	2009-07-14 13:11:33.311860683 -0400
@@ -1,22 +1,23 @@
-
-SYMBOL
+SYMBOLSET
+  SYMBOL
     NAME 'circle' 
     TYPE ellipse 
     FILLED true 
     POINTS
       1 1 
     END 
-END
+  END
 
-SYMBOL
+  SYMBOL
     NAME 'xmarks-png'
     TYPE PIXMAP
     IMAGE 'xmarks.png'
-END
+  END
 
-SYMBOL
+  SYMBOL
     NAME 'home-png'
     TYPE PIXMAP
     IMAGE 'home.png'
+  END
 END
 
