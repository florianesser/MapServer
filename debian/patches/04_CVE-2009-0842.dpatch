#! /bin/sh /usr/share/dpatch/dpatch-run
## 04_CVE-2009-0842.dpatch by Alan Boudreault <aboudreault@mapgears.com>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: No description.

@DPATCH@
diff -urNad mapserver-5.0.3~/mapserver.h mapserver-5.0.3/mapserver.h
--- mapserver-5.0.3~/mapserver.h	2008-06-04 15:43:45.000000000 -0400
+++ mapserver-5.0.3/mapserver.h	2009-06-08 13:33:31.870603634 -0400
@@ -150,7 +150,9 @@
 /* General defines, not wrapable */
 #ifndef SWIG
 #define MS_DEFAULT_MAPFILE_PATTERN "\\.map$"
-#define MS_TEMPLATE_EXPR "\\.(jsp|asp|cfm|xml|wml|html|htm|shtml|phtml|php|svg)$"
+
+#define MS_TEMPLATE_MAGIC_STRING "MapServer Template"
+#define MS_TEMPLATE_EXPR "\\.(xml|wml|html|htm|svg|kml|gml|js|tmpl)$"
 
 #define MS_INDEX_EXTENSION ".qix"
 #define MS_QUERY_EXTENSION ".qy"
diff -urNad mapserver-5.0.3~/maptemplate.c mapserver-5.0.3/maptemplate.c
--- mapserver-5.0.3~/maptemplate.c	2007-08-24 14:22:05.000000000 -0400
+++ mapserver-5.0.3/maptemplate.c	2009-06-08 13:33:31.870603634 -0400
@@ -40,6 +40,20 @@
 
 char *processLine(mapservObj* msObj, char* instr, int mode);
 
+static int isValidTemplate(FILE *stream, const char *filename)
+{
+  char buffer[MS_BUFFER_LENGTH];
+
+  if(fgets(buffer, MS_BUFFER_LENGTH, stream) != NULL) {
+    if(!msCaseFindSubstring(buffer, MS_TEMPLATE_MAGIC_STRING)) {
+      msSetError(MS_WEBERR, "Missing magic string, %s doesn't look like a MapServer template.", "isValidTemplate()", filename);
+      return MS_FALSE;
+    }
+  }
+
+  return MS_TRUE;
+}
+
 /*
  * Redirect to (only use in CGI)
  * 
@@ -2392,6 +2406,11 @@
           return(NULL);
         }
 
+	if(isValidTemplate(stream, join->header) != MS_TRUE) {
+	  fclose(stream);
+	  return NULL;
+	}
+
         /* echo file to the output buffer, no substitutions */
         while(fgets(line, MS_BUFFER_LENGTH, stream) != NULL) outbuf = msStringConcatenate(outbuf, line);
 
@@ -2402,7 +2421,12 @@
         msSetError(MS_IOERR, "Error while opening join template file %s.", "processOneToManyJoin()", join->template);
         return(NULL);
       }      
-      
+     
+      if(isValidTemplate(stream, join->template) != MS_TRUE) {
+	fclose(stream);
+	return NULL;
+      }
+ 
       records = MS_TRUE;
     }
     
@@ -2417,6 +2441,7 @@
     }
       
     rewind(stream);
+    fgets(line, MS_BUFFER_LENGTH, stream); /* skip the first line since it's the magic string */
   } /* next record */
 
   if(records==MS_TRUE && join->footer) {    
@@ -2425,6 +2450,11 @@
       return(NULL);
     }
 
+    if(isValidTemplate(stream, join->footer) != MS_TRUE) {
+      fclose(stream);
+      return NULL;
+    }
+
     /* echo file to the output buffer, no substitutions */
     while(fgets(line, MS_BUFFER_LENGTH, stream) != NULL) outbuf = msStringConcatenate(outbuf, line);
     
diff -urNad mapserver-5.0.3~/mapfile.c mapserver-5.0.3/mapfile.c
--- mapserver-5.0.3~/mapfile.c	2008-01-20 11:11:29.000000000 -0500
+++ mapserver-5.0.3/mapfile.c	2009-06-08 13:35:53.641855604 -0400
@@ -4228,10 +4228,20 @@
 static int loadMapInternal(mapObj *map)
 {
   int i,j,k;
+  int foundMapToken=MS_FALSE; 
+  int token;
 
   for(;;) {
 
-    switch(msyylex()) {   
+    token = msyylex(); 
+
+    if(!foundMapToken && token != MAP) { 
+      msSetError(MS_IDENTERR, "First token must be MAP, this doesn't look like a mapfile.", "msLoadMap()"); 
+      return(MS_FAILURE); 
+    }
+
+    switch(token) {
+
 
     case(CONFIG):
     {
@@ -4358,6 +4368,7 @@
       if(loadLegend(&(map->legend), map) == -1) return MS_FAILURE;
       break;
     case(MAP):
+      foundMapToken = MS_TRUE; 
       break;   
     case(MAXSIZE):
       if(getInteger(&(map->maxsize)) == -1) return MS_FAILURE;
diff -urNad mapserver-5.0.3~/mapsymbol.c mapserver-5.0.3/mapsymbol.c
--- mapserver-5.0.3~/mapsymbol.c	2007-11-08 10:19:29.000000000 -0500
+++ mapserver-5.0.3/mapsymbol.c	2009-06-08 13:35:53.651858522 -0400
@@ -616,7 +616,7 @@
 int msLoadSymbolSet(symbolSetObj *symbolset, mapObj *map)
 {
     int retval = MS_FAILURE;
-    
+
     msAcquireLock( TLOCK_PARSER );
     retval = loadSymbolSet( symbolset, map );
     msReleaseLock( TLOCK_PARSER );
@@ -631,6 +631,9 @@
   int status=1;
   char szPath[MS_MAXPATHLEN], *pszSymbolPath=NULL;
 
+  int foundSymbolSetToken=MS_FALSE;
+  int token;
+
   if(!symbolset) {
     msSetError(MS_SYMERR, "Symbol structure unallocated.", "loadSymbolSet()");
     return(-1);
@@ -657,7 +660,15 @@
   ** Read the symbol file
   */
   for(;;) {
-    switch(msyylex()) {
+
+    token = msyylex();
+
+    if(!foundSymbolSetToken && token != SYMBOLSET) {
+      msSetError(MS_IDENTERR, "First token must be SYMBOLSET, this doesn't look like a symbol file.", "msLoadSymbolSet()");
+      return(-1);
+    }
+
+    switch(token) {
     case(END):
     case(EOF):      
       status = 0;
@@ -673,6 +684,7 @@
           symbolset->numsymbols++;
       break;
     case(SYMBOLSET):
+      foundSymbolSetToken = MS_TRUE;
       break;
     default:
       msSetError(MS_IDENTERR, "Parsing error near (%s):(line %d)", "loadSymbolSet()", msyytext, msyylineno);
diff -urNad mapserver-5.0.3~/tests/symbols.txt mapserver-5.0.3/tests/symbols.txt
--- mapserver-5.0.3~/tests/symbols.txt	2004-11-18 10:07:36.000000000 -0500
+++ mapserver-5.0.3/tests/symbols.txt	2009-06-08 13:35:53.651858522 -0400
@@ -1,22 +1,22 @@
-
-SYMBOL
+SYMBOLSET
+  SYMBOL
     NAME 'circle' 
     TYPE ellipse 
     FILLED true 
     POINTS
       1 1 
     END 
-END
+  END
 
-SYMBOL
+  SYMBOL
     NAME 'xmarks-png'
     TYPE PIXMAP
     IMAGE 'xmarks.png'
-END
+  END
 
-SYMBOL
+  SYMBOL
     NAME 'home-png'
     TYPE PIXMAP
     IMAGE 'home.png'
+  END
 END
-
