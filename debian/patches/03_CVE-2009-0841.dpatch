#! /bin/sh /usr/share/dpatch/dpatch-run
## 03_CVE-2009-0841.dpatch by Alan Boudreault <aboudreault@mapgears.com>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: No description.

@DPATCH@
diff -urNad mapserver-5.0.3~/mapserv.c mapserver-5.0.3/mapserv.c
--- mapserver-5.0.3~/mapserv.c	2007-09-10 09:51:19.000000000 -0400
+++ mapserver-5.0.3/mapserv.c	2009-06-08 13:35:11.130609480 -0400
@@ -357,6 +370,10 @@
     }
 
     if(strcasecmp(msObj->request->ParamNames[i],"id") == 0) {
+      if(msEvalRegex(IDPATTERN, msObj->request->ParamValues[i]) == MS_FALSE) { 
+        msSetError(MS_WEBERR, "Parameter 'id' value fails to validate.", "loadMap()"); 
+        writeError(); 
+      } 
       strncpy(msObj->Id, msObj->request->ParamValues[i], IDSIZE);
       continue;
     }
diff -urNad mapserver-5.0.3~/maptemplate.h mapserver-5.0.3/maptemplate.h
--- mapserver-5.0.3~/maptemplate.h	2007-08-30 09:52:07.000000000 -0400
+++ mapserver-5.0.3/maptemplate.h	2009-06-08 13:33:31.860604977 -0400
@@ -34,7 +34,8 @@
 #include "maphash.h"
 
 #define IDSIZE 64 
+#define IDPATTERN "^[0-9A-Za-z]{1,63}$" 
 #define TEMPLATE_TYPE(s)  (((strncmp("http://", s, 7) == 0) || (strncmp("https://", s, 8) == 0) || (strncmp("ftp://", s, 6)) == 0)  ? MS_URL : MS_FILE)
 #define MAXZOOM 25
 #define MINZOOM -25